\documentclass[../../ThesisDoc]{subfiles}

\begin{document}

\providecommand{\rootdir}{../..}
\input{\rootdir/MathDefs}

\providecommand{\seccmd}[1]{\secpartc{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Group Agents}

\emph{Group agents} play active role in the negotiation.
Initially, each group generates a \emph{random candidate}.
Generation process ensures that \emph{class coherence} constraints
($\restrC$ and $\restrT$) are satisfied, thus implementing \textit{Capabilities}
and \textit{Time Consistency} contexts at once. It consists of three stages:
\begin{enumerate}
  \item \emph{Class-Cores Pool} generation.
  \item Generation of a \emph{class-cores} from the \emph{pool}.
  \item \emph{Day-Time-Room} assignment.
  %  Values are generated randomly for the
  %       entire set of class-cores, respecting time restrictions $\restrT$.
  %       % Classes duration is specified alongside each discipline.
\end{enumerate}


\noindent
After estimating generated candidate's coherence, the agent either tries to put
it into the \emph{common schedule variable} or generates a new one.

\red{
After estimating generated candidate's coherence, a decision is chosen:\\
\begin{itemize}
  \item Create new class-core pool.
  \item Try next class-core.
  \item Try another day-time-room configuration.
  \item Assess coherence in another \emph{mode}.
  \item Negotiate over a candidate.
  \item Fail with error.
\end{itemize}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Class-Cores}
\label{sec:solution-CC}

A class core is considered to be the immutable part of a class, that doesn't
change during its existence. It links \emph{group} and \emph{professor} agents
through a \emph{discipline}, respecting the \emph{capability} restrictions $\restrC$.
It can also be seen as an ``abstract'' class, with no time or classroom assigned.

A \emph{Class-Cores Pool} is a lazy random sequence of \emph{class-cores},
that contains a class for each discipline, needed by the group.

\emph{Pool} creation requires knowledge of the existing professor agents with
the disciplines, that the represented person can teach.
\begin{enumerate}
  \item For each discipline needed select professors, that can teach it.
        Randomize professors lists.
  \item Lazily generate all possible combinations \emph{professor} -- \emph{discipline}.
  \item When getting next combination, assign the generating \emph{group}.
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Day -- Time -- Room}
\label{sec:solution-DTR}

In order to obtain concrete classes, the cores must be completed with day, room,
beginning time and duration (end time), while respecting both discipline duration
requirements and time consistency $\restrT$.

Assigning the missing values can be seen as mapping (randomly) the set of cores onto
3-dimensional space: $\left< \text{day, time, room} \right>$.
In order to do it, a random generator is used. It uses a history variable to
store generated values and test time consistency of the new ones against the former.
The following process is repeated for each class core (using same generator).
\begin{enumerate}
  \item Generate random \emph{day}.
  \item Select random \emph{classroom}.
  \item Generate \emph{beginning time}.
  \item Get class duration from the \emph{discipline}, contained in argument class-core.
        Calculate \emph{end time}.
  \item Test \emph{end time} consistency (upper bound).
  \item Test \emph{time consistency} of the values from (1-4) using the history.
  \item If new values are consistent, add them to history, assign to class-core
        and return it.
        Otherwise, repeat from (1).

\end{enumerate}
After the assignment has been done for all the class-cores in the given set,
the history variable is reset.

\medskip

With rather big set of classrooms and adequate time discretization, the generated
values can be considered unique with a rather high probability.
\red{Put numbers here?}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{\rootdir/img/CandidateNegotiation.tikz}

\begin{figure}[h]
  \begin{subfigure}{0.3\textwidth}
    \drawFirstAlone{2cm} % using CandidateNegotiation.tikz
    \caption{}
    \label{fig:candidate-1}
  \end{subfigure}
  ~
  \begin{subfigure}{0.3\textwidth}
    \drawSecondAlone[trim left, xshift=1.7cm]{2cm} % using CandidateNegotiation.tikz
    \caption{}
    \label{fig:candidate-2}
  \end{subfigure}
  ~
  \begin{subfigure}{0.3\textwidth}
    \drawThirdAlone{2cm} % using CandidateNegotiation.tikz
    \caption{}
    \label{fig:candidate-3}
  \end{subfigure}

  \caption{Possible candidates, generated by some \emph{group} agents
            $G_1$ (\ref{fig:candidate-1}), $G_2$ (\ref{fig:candidate-2}) and
            $G_3$ (\ref{fig:candidate-3}).}
  \label{fig:candidates-alone}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Candidate placement}
\begin{itemize}
  \item If generated candidate was found coherent by all contexts,
        then the agent must try to put it in the \emph{common schedule}
        (see section \ref{sec:solution-schedule-var}).
        \begin{itemize}
          \item In case of successful candidate placement, the agent ``goes to sleep'',
                until disturbed by \emph{yield} or \emph{continuation} demands.
          \item In case of conflicts with any candidates, already existing
                in current schedule, the conflict is resolved as described
                in section \ref{sec:solution-compare}.
                \begin{itemize}
                  \item It the conflict is resolved in favor of the agent,
                        then it tries again to put the candidate into the
                        schedule, providing evidence of its superiority.
                \end{itemize}
        \end{itemize}
  \item If the candidate was found incoherent or has lost a conflict competition,
        then the candidate must be changed, as described in section
        \ref{sec:solution-change}.
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Placement Conflicts Resolution --- Candidates Comparison}
\label{sec:solution-compare}

A conflict over placing a candidate $\tilde{c}_i$ into the schedule arises
between candidates' creators: group agents $g_i$ and $\{g_k\}$.
The latter are group agents, that have proposed the conflicting classes
as part of their candidates.

As it was mentioned earlier, candidates ``quality'' comparison is not only based
on coherence, but also on candidates ``rareness'', based on \emph{discipline priority}.
There is a third measure: \emph{deep} (or \emph{cascade}) coherence.

\medskip
\noindent
These measures have priorities:
$$ \text{Ext. coherence} < \text{Deep ext. coherence} < \text{Discipline priority} $$

\medskip
\noindent
Agents' goal in this sub-negotiation is providing a stronger support for its
candidate. The ``newcomer'', an agent that is wants to put its candidate, is
in disadvantage here: it must beat all the conflicting candidates at once in
order to receive a place. The conflicting candidates, already put in the schedule,
keep their places if at least one of them was found better then the ``newcomer''.
It the latter could prove its candidate superiority in every conflict, then
it can demand candidate's placement (attaching victory proofs).
If no new conflict has arisen, the \emph{schedule controller}
(see section \ref{sec:solution-schedule-var}) puts the new candidate into the
common variable, removing the conflicting candidates (given proof) and notifying
corresponding creators with \emph{yield demand}.


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\seccmd{External coherence}
Is used for preliminary/default assessment of the candidates.
Evaluation is done with ``preliminary'' context assessment \emph{mode}, that
disables certain relations; it is intended primarily to be used by professor agents.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\seccmd{Deep external coherence}
Cascade external coherence of depth $N$. Can be assessed in either \emph{preliminary}
or \emph{final} context assessment mode. Deep coherence has higher priority if
assessed in the latter mode (than in the former, not ``rareness'').

\red{Maximum depth is limited by other conflicts in the schedule. No class
(or its references), belonging to a contested candidate, can be used in the evaluation.}
$N$ is the maximum depth of evaluation recursive calls reached. The limit can
be set at the beginning of evaluation; if not, the process will cover all
\red{valid} routes (avoiding cycles).
Depth of the default external coherence is 0 --- only own external coherence is
considered.

\bigskip
\noindent
\red{here goes \emph{connections} matrix diagram}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %

\seccmd{Candidate ``rareness''}
Sum of ``rare'' disciplines' priorities. Discipline's ``rarity'' (or
\emph{priority}) is ratio
\begin{itemize}
  \item[\textit{of}] groups \red{(total groups' time)} enrolled to the discipline ($N_G$)
  \item[\textit{to}] professors able to teach it ($N_P$).
\end{itemize}

$$\rho^d = \dfrac{N_G}{N_P}$$

\medskip
\noindent
Discipline $d$ is considered ``rare'' if its priority $\rho_d$ is higher than
some threshold. \\
\noindent
Candidate's ``rareness'' $\rho_{\tilde{c}}$ therefore is
\begin{align*}
  \rho_{\tilde{c}} &= \sum\limits_{d \in D'_{\tilde{c}}}
        \rho^d \mathsmaller{ \sum\limits_{c \in \tilde{c}'_d}
                              \mathit{duration}\, c }\\
  D'_{\tilde{c}} &= \lbrace d ~|~ d ~\mathit{referenced\,by}~ \tilde{c};~
                                \rho_d > \rho_* \rbrace\\
  \tilde{c}'_d &= \lbrace c ~|~ c \in \tilde{c};~ c ~\mathit{is\,class\,for}~ d \rbrace
\end{align*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Change of a candidate}
\label{sec:solution-change}

Triggered either when a candidate was found \emph{not sufficiently coherent}
(see section \ref{sec:solution-better}) immediately after generation
or as a result of loosing candidates conflict.
When the change was caused by a conflict, then agent must consider adversaries'
quality values and try to better them.

Agent should first try to achieve expected quality by changing
\emph{day}, \emph{time} and \emph{classroom} parameters of candidate's classes
(see section \ref{sec:solution-DTR}).
If it is unable to find a satisfying candidate by these changes within some
reasonable negotiation time, then it should generate a candidate with new
\emph{class core} (see section \ref{sec:solution-CC}).

When class cores end up, an error would be raised by the agent, causing the whole
negotiation to terminate.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Messaging}
\todo

\end{document}
